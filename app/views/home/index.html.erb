<h1>Sam's Ski Deals</h1>

<h2>Current Status</h2>

<p>
  Last updated:
  <% if @site_status.updated_at.present? %>
    <%= @site_status.updated_at.in_time_zone("Europe/London").strftime("%-d %B %Y %H:%M") %>
  <% else %>
    never
  <% end %>
</p>

<% if authenticated? %>
  <%= form_with model: @site_status, url: site_status_path, method: :patch do |f| %>
    <div>
      <%= f.label :body, "What's going on in the Alps right now?" %><br>
      <%= f.text_area :body, rows: 8, cols: 80 %>
    </div>
    <div style="margin-top: 8px;">
      <%= f.label :featured_deal_id, "Featured deal ID (optional)" %><br>
      <%= f.number_field :featured_deal_id, size: 10 %>
      <% if @featured_deal.present? %>
        <small>
          Currently:
          <strong>#<%= @featured_deal.id %></strong> â€”
          <%= (@featured_deal.description.presence || @featured_deal.url).truncate(60) %>
        </small>
      <% end %>
    </div>
    <div>
      <%= f.submit "Save status" %>
    </div>
  <% end %>
<% else %>
  <div>
    <%= simple_format(@site_status.body.presence || "No status yet.") %>
  </div>
<% end %>

<hr>

<% if @featured_deal.present? %>
  <h2>Featured deal</h2>

  <p>
    <% link_text = @featured_deal.description.presence || @featured_deal.url %>
    <a href="<%= @featured_deal.url %>" target="_blank" rel="noopener noreferrer">
      <%= link_text %>
    </a>

    <small>
      (added
      <%= @featured_deal.created_at.in_time_zone("Europe/London").strftime("%-d %b %Y %H:%M") %>
      )
    </small>
  </p>

  <% if @featured_deal.note.present? %>
    <p><%= simple_format(@featured_deal.note) %></p>
  <% end %>

  <!-- Broken + reset buttons for featured deal -->
  <p>
    <%= button_to "Broken/Outdated?",
      report_broken_deal_path(@featured_deal),
      method: :patch,
      form: { data: { turbo_stream: true }, style: "display:inline; margin-right: 4px;" },
      data: {
        turbo_confirm: "Is it really broken? Because it's really annoying if it's not and you're just clicking it anyway."
      } %>

    <% if authenticated? %>
      <%= button_to "Reset",
        reset_broken_deal_path(@featured_deal),
        method: :patch,
        form: { data: { turbo_stream: true }, style: "display:inline; margin-left: 4px;" },
        data: { turbo_confirm: "Reset broken report count for this featured deal?" } %>
    <% end %>
  </p>
<% end %>


<hr>
<hr>

<!-- DEALS SECTION -->
<h2>All Deals</h2>

<h3>
  Current deals - as of
  <% if @deals_last_updated_at.present? %>
    <%= @deals_last_updated_at.in_time_zone("Europe/London").strftime("%-d %B %Y %H:%M") %> UK Time
  <% else %>
    never
  <% end %>
</h3>

<% if authenticated? %>
    <% broken = Deal.where("broken_reports_count > 0").order(broken_reports_count: :desc) %>

    <% if broken.any? %>
      <p style="font-size: 1em; color: #ff0000ff; margin-bottom: 8px;">
        Broken reports on
        <%=
          broken.map { |d|
            # underline the deal ID, superscript the count
            "#{d.id}<sup>#{d.broken_reports_count}</sup>"
          }.join(", ").html_safe
        %>
      </p>
    <% else %>
      <p style="font-size: 0.9em; color: #666; margin-bottom: 8px;">
        No broken reports.
      </p>
    <% end %>
  <% end %>

<% if authenticated? %>
  <h3>Add a new deal</h3>
  <%= form_with model: Deal.new, url: deals_path do |f| %>
    <div>
      <%= f.label :url %><br>
      <%= f.text_field :url, size: 80 %>
    </div>
    <div>
      <%= f.label :description, "Link text (optional)" %><br>
      <%= f.text_field :description, size: 80 %>
    </div>
    <div style="margin-top: 4px;">
      <%= f.label :note, "Note (optional)" %><br>
      <%= f.text_area :note, rows: 4, cols: 80 %>
    </div>
    <div>
      <%= f.submit "Add deal" %>
    </div>
  <% end %>
<% end %>

<% if @deals.any? %>
  <%= render partial: "deals/list", locals: { deals: @deals } %>


<% else %>
  <p>No deals yet.</p>
<% end %>

<hr>

<p>
  <% if authenticated? %>
    Signed in as <%= Current.user.email_address %>.
    <%= button_to "Sign out", session_path, method: :delete %>
  <% else %>
    <%= link_to "Admin keep out", new_session_path %>
  <% end %>
</p>
