<h1>Sam's Ski Deals</h1>

<h2>Current Status</h2>

<p>
  Last updated:
  <% if @site_status.updated_at.present? %>
    <%= @site_status.updated_at.in_time_zone("Europe/London").strftime("%-d %B %Y %H:%M") %>
  <% else %>
    never
  <% end %>
</p>

<% if authenticated? %>
  <%= form_with model: @site_status, url: site_status_path, method: :patch do |f| %>
    <div>
      <%= f.label :body, "What's going on in the Alps right now?" %><br>
      <%= f.text_area :body, rows: 8, cols: 80 %>
    </div>
    <div>
      <%= f.submit "Save status" %>
    </div>
  <% end %>
<% else %>
  <div>
    <%= simple_format(@site_status.body.presence || "No status yet.") %>
  </div>
<% end %>

<hr>

<!-- DEALS SECTION -->
<h2>Deals</h2>

<h3>
  Current deals - as of
  <% if @deals_last_updated_at.present? %>
    <%= @deals_last_updated_at.in_time_zone("Europe/London").strftime("%-d %B %Y %H:%M") %> UK Time
  <% else %>
    never
  <% end %>
</h3>

<% if authenticated? %>
  <h3>Add a new deal</h3>
  <%= form_with model: Deal.new, url: deals_path do |f| %>
    <div>
      <%= f.label :url %><br>
      <%= f.text_field :url, size: 80 %>
    </div>
    <div>
      <%= f.label :description, "Link text (optional)" %><br>
      <%= f.text_field :description, size: 80 %>
    </div>
    <div style="margin-top: 4px;">
      <%= f.label :note, "Note (optional)" %><br>
      <%= f.text_area :note, rows: 4, cols: 80 %>
    </div>
    <div>
      <%= f.submit "Add deal" %>
    </div>
  <% end %>
<% end %>

<% if @deals.any? %>
  <ul>
    <% @deals.each do |deal| %>
      <li data-deal-id="<%= deal.id %>">
        <% link_text = deal.description.presence || deal.url %>
        <a href="<%= deal.url %>" target="_blank" rel="noopener noreferrer">
          <%= link_text %>
        </a>
        <small>
          (updated
          <%= deal.updated_at.in_time_zone("Europe/London").strftime("%-d %b %Y %H:%M") %>
          )
        </small>
        <% if deal.note.present? %>
          <details style="display:inline; margin-left: 8px;">
            <summary style="display:inline; cursor:pointer; list-style:none;">
              <span class="triangle">
                â–¸
              </span>
              <b>See Note!!</b>
            </summary>
            <p style="margin-top:8px;"><%= simple_format(deal.note) %></p>
          </details>
        <% end %>





        <% if authenticated? %>
          <!-- Simple inline edit for description/url -->
          <details style="margin-top: 4px;">
            <summary>Edit</summary>
            <%= form_with model: deal, url: deal_path(deal), method: :patch do |f| %>
              <div>
                <%= f.label :url %><br>
                <%= f.text_field :url, value: deal.url, size: 60 %>
              </div>
              <div>
                <%= f.label :description, "Link text (optional)" %><br>
                <%= f.text_field :description, value: deal.description, size: 60 %>
              </div>
              <div style="margin-top: 4px;">
                <%= f.label :note, "Note (optional)" %><br>
                <%= f.text_area :note, value: deal.note, rows: 4, cols: 60 %>
              </div>
              <div>
                <%= f.submit "Update" %>
              </div>
            <% end %>

            <div style="margin-top: 4px;">
              <%= button_to "Delete", deal_path(deal), method: :delete, data: { turbo_confirm: "Delete this deal?" } %>
            </div>
          </details>
        <% end %>
      </li>
      <br>
    <% end %>
  </ul>

<% else %>
  <p>No deals yet.</p>
<% end %>

<hr>

<p>
  <% if authenticated? %>
    Signed in as <%= Current.user.email_address %>.
    <%= button_to "Sign out", session_path, method: :delete %>
  <% else %>
    <%= link_to "Admin keep out", new_session_path %>
  <% end %>
</p>
